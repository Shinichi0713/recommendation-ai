## CRDを解くステップ

ターゲット画素 $y$ に対して異常スコアを算出するまでの手順は、以下の5つのステップで構成されます。

1. データの正規化（Preprocessing）

数値計算を安定させるため、ターゲット画素 $y$ および背景辞書 $D$ の各ベクトル（列）を正規化します。
各ベクトルをそのL2ノルム（長さ）で割り、単位ベクトルにします。これにより、明るさの変化の影響を抑え、純粋な「成分の構成比（色やスペクトルの形）」で比較できるようになります。

列ベクトルをL2ノルムで削っていき、単位ベクトルにする。

明るさ影響を抑えて、成分の構成比を比較できるようにする。

2. 相関行列の計算背景辞書 

$D$（サイズ：$d \times n$）から、背景画素同士の類似度を示す行列を作ります。計算式： $D^T D$これにより $n \times n$ （背景画素数 × 背景画素数）の行列が得られます。

1. 二重窓（Dual Window）による空間サンプリング

まず、注目しているターゲット画素 $(x, y)$ を中心に、2つの同心円状の正方形（窓）を設定します。
- 内窓 ($W_{in} \times W_{in}$): ガード窓。ターゲットとその周辺（異常の広がり）を除外する範囲。
- 外窓 ($W_{out} \times W_{out}$): 背景サンプリング窓。背景データを収集する範囲。
 
__数学的な抽出条件__

座標 $(i, j)$ にある画素が辞書 $D$ に採用される条件は以下の通りです。

$$\max(|x-i|, |y-j|) \leq \frac{W_{out}-1}{2}$$

かつ

$$\max(|x-i|, |y-j|) > \frac{W_{in}-1}{2}$$

2. 画素のベクトル化（多次元化）

抽出された各画素を、計算可能な形式（列ベクトル）に変換します。
- カラー画像（RGB）の場合:各画素は 3次元ベクトル $v = [R, G, B]^T$ となります。
- ハイパースペクトル画像の場合:各画素は $L$ 個のバンド（波長）を持つ $L$ 次元ベクトル $v = [b_1, b_2, \dots, b_L]^T$ となります。

抽出された $n$ 個の画素を横に並べることで、辞書行列 $D$ が完成します。

$$D = [v_1, v_2, \dots, v_n] \in \mathbb{R}^{L \times n}$$

ここで、$L$ はデータの次元数（バンド数）、$n$ は背景画素の総数です。

3. データの前処理（重要）
 
行列 $D$ をそのまま使うのではなく、計算精度を上げるために以下の処理（平均除去と正規化）を行うのが一般的です。

① 局所的な中心化（Local Centering）ターゲット画素 $y$ と辞書 $D$ のすべての列ベクトルから、辞書の平均ベクトル $\mu_D$ を引きます。

$$\tilde{D} = [v_1 - \mu_D, v_2 - \mu_D, \dots, v_n - \mu_D]$$

$$\tilde{y} = y - \mu_D$$

これにより、照明の明るさのベースライン（直流成分）を排除し、 **純粋な色の構成（変化成分）** に焦点を当てることができます。

② ノルム正規化（Normalization）

各ベクトルをその長さ（L2ノルム）で割ります。

$$v_i' = \frac{v_i}{\|v_i\|_2}$$

これにより、影の影響などで暗くなっている背景画素も、明るい画素と同じ重みで「色成分」として評価できるようになります。

4. 辞書サイズ $n$ の具体的な計算
 
例えば、外窓 $15 \times 15$、内窓 $5 \times 5$ の場合、辞書 $D$ に含まれる画素数 $n$ は以下のようになります。

$$n = (15^2) - (5^2) = 225 - 25 = 200 \text{ pixels}$$

RGB画像なら $D$ は $[3 \times 200]$、100バンドのハイパースペクトル画像なら $[100 \times 200]$ の行列になります。

5. なぜこの「並べ方」が重要なのかこの行列 $D$ の各列は、その場所で「あり得る色のサンプル」です。CRDの最適化アルゴリズムは、この $D$ の列ベクトルを適当な比率で足し合わせ（線形結合）、ターゲットを再現しようとします。

- 正常な場所: ターゲットの周囲には似たようなサンプルが多いため、$D$ の中から簡単にターゲットを合成できます。
- 異常な場所: 周囲には「緑色の葉」のサンプルしかないのに、ターゲットが「赤いプラスチック」であれば、$D$ の列をどう組み合わせても「赤」を作ることはできず、大きな再構成誤差が発生します。

CRDは、以下の式を最小化するような重みベクトル $\alpha$ を求めます。

$$J(\alpha) = \underbrace{\|y - D\alpha\|_2^2}_{\text{再構成誤差}} + \lambda \underbrace{\|\alpha\|_2^2}_{\text{正則化項}}$$

この式は、2つの相反する目標を同時に達成しようとしています。第1項（再構成誤差）: ターゲット $y$ と、背景画素の混ぜ合わせ（$D\alpha$）の差を最小にします。「できるだけ正確に再現せよ」という命令です。第2項（$L_2$ 正則化）: 重み $\alpha$ の大きさの二乗和を最小にします。特定の背景画素だけに頼らず、多くの画素に「協調的（Collaborative）」に役割を分散させ、「重みが極端に大きくならないようにせよ」という命令です。$\lambda$（正則化パラメータ）: この2つの目標のバランスを調整する小さな正の値です。


