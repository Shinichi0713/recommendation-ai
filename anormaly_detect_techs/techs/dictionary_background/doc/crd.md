
**CRD (Collaborative Representation-based Detector)** は、主にハイパースペクトル画像や複雑なパターンを持つ工業製品の表面検査などで利用される異常検知アルゴリズムです。

あなたがこれまで見てきた **SRD (Sparse Representation-based Detector)** の「計算コスト」と「背景モデルの不安定さ」という課題を解決するために提案されました。

## SRD
**SRD (Sparse Representation-based Detector)** は、「スパース表現（まばらな表現）」という数学的理論を異常検知に応用した手法です。

CRD（協調表現）が「全員で協力して再現する」のに対し、SRDは **「辞書の中から、本当に必要な数個のパーツだけを選び抜いて再現する」** というアプローチを取ります。


### 1. SRDが計算の前提（仮定）としていること

SRDが成立するためには、以下の**2つの強力な前提条件**があります。

#### 前提①：背景のスパース性（Sparse Prior）

「どんなに複雑に見える正常な背景も、あらかじめ用意した **『正常なパッチの辞書（原子）』のうち、ごく少数の組み合わせ** だけで表現できる」という仮定です。

* 例えば、1,000個のパターンが入った辞書があっても、ある特定の背景画素を再現するには、そのうちの3〜5個程度のパーツがあれば十分である、と考えます。

#### 前提②：異常の非圧縮性

「異常（キズや異物）は、正常なパッチの辞書には含まれていないため、**正常辞書をどう組み合わせてもスパース（少数）には表現できない**」という仮定です。

* もし異常箇所を無理やり正常辞書で再現しようとすると、大量のパッチを複雑に組み合わせる必要があり、結果として「再構成誤差」が非常に大きくなります。


### 2. 数学的なメカニズム： ノルム最小化

SRDは、ターゲット画素 $y$ を辞書 $D$ と重み係数 $\alpha$ を用いて $y \approx D\alpha$ と表す際、以下の最適化問題を解きます。

$$
\min_{\alpha} \|y - D\alpha\|_2^2 + \lambda \|\alpha\|_1
$$

* **第一項（誤差）**: 辞書を使ってどれだけ正確に再現できたか。
* **第二項（スパース制約）**: **ここがSRDのキモです。**  $\alpha$ の $L_1$ ノルム（絶対値の和）を最小化することで、「重み $\alpha$ のほとんどをゼロにせよ（＝使うパッチを最小限にせよ）」と強制します。

### 3. SRDの手順

1. **辞書の構築**:
正常画像から小さなパッチ（例： ピクセル）を大量に抜き出し、これを行列  としてまとめます。
2. **スパース符号化（最適化）**:
テスト画像の各点に対し、上記の  最小化問題を解き、最適な重み  を見つけます。
3. **異常スコアの算出**:
辞書で再現できなかった残差  を計算します。
* **正常**: 少ないパッチで綺麗に再現できる → 残差が小さい。
* **異常**: 辞書に似たパーツがないため再現に失敗する → **残差が大きい。**



### 4. SRDの課題（なぜCRDが生まれたか）

* **計算が極めて重い**:
 最小化は反復計算が必要な凸計画問題（ISTAなど）であり、画像全体の全画素でこれを行うと、処理に膨大な時間がかかります。
* **辞書への依存度が高い**:
辞書に「たまたま似たノイズ」が入っていると、それを異常として拾ってしまったり、逆に異常を正常と誤認したりする不安定さがありました。

## CRD
CRD (Collaborative Representation-based Detector) は、主にハイパースペクトル画像や複雑なパターンを持つ工業製品の表面検査などで利用される異常検知アルゴリズムです。

SRDは非常に強力ですが、実務上は以下の理由で敬遠されることがありました。

SRDの「計算コスト」と「背景モデルの不安定さ」という課題を解決するために提案されました。

### 1. CRDの概要： 「お隣さん」の協力で自分を再現する

CRDの根本にある考え方は、 **正常な画素は、その周囲（近傍）にある画素たちの線形結合（重み付き合計）で近似できる** というものです。

* **仕組み**:
ターゲットとなる画素の周りに「二重の窓（Dual Window）」を設定します。外側の窓（背景領域）に存在する画素たちを **「背景辞書」** と見なし、それらを組み合わせて中心の画素を再現しようと試みます。
* **判定**:
周囲の画素をどう組み合わせても（＝協力させても）再現できない部分が残れば、それは周囲とは明らかに性質が異なる **異常（Anomaly）** であると判定します。


### 2. CRDが解決しようとした「3つの課題」

CRDが登場した背景には、それまでの主流だった **RX Detector** や **SRD** が抱えていた以下の課題がありました。

#### ① RX Detectorの「背景分布の仮定」という限界

* **課題**: RXは背景が「多変量正規分布（単一の塊）」であることを前提としています。しかし、実際の背景には複数の素材や複雑な模様が混ざっており、一つの統計量ではうまく表現できず、誤検知が多発していました。
* **解決**: CRDは特定の分布を仮定せず、 **「今、目の前にある周囲の画素」** を直接辞書として使うため、複雑で不均一な背景にも柔軟に適応できます。

#### ② SRDの「膨大な計算コスト」という壁

* **課題**: スパース表現（SRD）は「辞書の中からごく少数の要素を選び出す（$L_1$ ノルム最小化）」という非常に重い最適化計算を全画素で行う必要があり、リアルタイム処理が困難でした。
* **解決**: CRDは「辞書の全員を適度に使って再現する（$L_2$ ノルム最小化）」という手法をとります。これは数学的には**最小二乗法**に近く、行列演算（逆行列）だけで解けるため、**SRDより数十倍〜数百倍高速**に動作します。

#### ③ スパース性の「不安定さ」

* **課題**: SRDのように「少数の要素」に頼りすぎると、ノイズが乗った際に選ばれるパッチがコロコロ変わり、判定が不安定になることがありました。
* **解決**: CRDは周囲の画素が **「協調的（Collaborative）」** にターゲットを表現するため、ノイズの影響が分散され、結果が安定しやすくなります。


### 3. CRDの処理イメージ（Dual Window戦略）

実装上、CRDは以下の構造（二重窓）で計算されます。

1. **ターゲット画素**: 中心の一点。
2. **ガード窓 (Guard Window)**: 中心の異常が背景辞書に混ざらないようにするための「空白地帯」。
3. **背景窓 (Background Window)**: ここにある画素すべてが「背景辞書」になります。


### 4. まとめ：なぜCRDが選ばれるのか

| 特徴 | RX | SRD | **CRD** |
| --- | --- | --- | --- |
| **背景モデル** | 統計的な分布（楕円） | 厳選されたパッチ | **周囲画素の共同体** |
| **計算負荷** | 低（高速） | 極めて高い（低速） | **中（実用的・高速）** |
| **複雑な背景** | 弱い | 強い | **非常に強い** |

**結論として：**
CRDは、 **「SRD並みの高い精度」を保持しつつ、「実用的な計算速度」を実現したバランスの良い手法** です。特に、場所によって背景が複雑に変化する画像において、その真価を発揮します。

これまで学んできた **RPCA** で「大枠の背景」を抜き出し、残った細かいノイズ混じりの成分に対して **CRD** を適用して「周囲と浮いている微細なキズ」を仕留める、という流れは非常に理にかなった強力なパイプラインになります。



