最適化問題は、与えられた問題のことを主問題。
主問題の制約条件から目的関数を導入した双対問題から構成されます。
本日はそんな双対問題について説明していきます。

## 主双対問題とは
最適化における **「双対性（Duality）」** は、ある問題を **「別の視点」** から眺めることを指します。
元々の問題を **「主問題（Primal Problem）」** 、それと表裏一体の関係にある問題を **「双対問題（Dual Problem）」** と呼びます。

### 1. 視点の違い：生産者 vs 資源価値
先日のジュース工場の例を使うと、非常に直感的に理解できます。

__先日のジュース工場の例__

>読者の方は一旦、ジュース工場の店長だとしていください。
>リンゴとオレンジを使って、「特製ミックス」と「濃厚ブレンド」の2種類のジュースを作っています。在庫のフルーツをどう配分すれば、 **売上を最大化** できるかを考えてみます。


主問題と双対問題は、同じ状況を「攻め」と「守り」の視点で捉え直したものです。

| 視点 | 主問題 (Primal) | 双対問題 (Dual) |
| --- | --- | --- |
| **主役** | 工場長（生産者） | 資源評価者（経営者） |
| **目的** | 売上を**最大化**したい | 資源の価値（コスト）を**最小化**したい |
| **変数** | どれだけ作るか ($x, y$) | 資源1gにいくらの価値があるか ($u, v$) |
| **制約** | 在庫（リソース）の限界 | 商品1杯を作るのに必要なコスト（利益以上） |


### 2. ジュース工場で考える双対問題

主問題が **「材料を使っていくら儲けるか」** だったのに対し、双対問題は **「材料（リンゴとオレンジ）そのものの価値をどう評価するか」** を考えます。

### 双対問題の考え方

もし、別の業者が「あなたの工場のリンゴとオレンジを全部買い取りたい」と言ってきたら、いくらで売るべきでしょうか？

* **変数 **：リンゴ 1g の価値（影の価格）
* **変数 **：オレンジ 1g の価値（影の価格）

#### 制約条件（価値の正当化）

業者が提示する価格 ($u, v$) は、あなたがジュースを作って得る利益よりも安くてはいけません。

* **特製ミックスの制約**:$100u + 200v \ge 500$ 円
* **濃厚ブレンドの制約**:$200u + 100v \ge 400$ 円

#### 目的関数（買い取り価格の最小化）

業者は、できるだけ安く買い取りたいと考えます。

* **合計価値**: $2000u + 2000v$ を最小化する。


## 主双対問題が必要な理由

主双対問題を考えるのは、単なる数学的なお遊びではありません。これが必要な理由は、主に **「経営判断のヒント」「計算効率の向上」「アルゴリズムの安定」** という3つの実利があるからです。

特に実務において重要な「なぜそれが必要か」という理由を紐解いていきます。


### 1. 「影の価格（Shadow Price）」がわかるから

これがビジネスにおいて最も強力な理由です。主問題を解くだけでは「今ある在庫でいくら儲かるか」しかわかりませんが、双対問題を解くと **「あと1単位リソースが増えたとき、いくら利益が跳ね上がるか」** がわかります。

* **例**: リンゴの「影の価格」が2円だとわかったとします。
* **判断**: 市場でリンゴが1gあたり1.5円で売っていたら、迷わず「買う」という判断ができます。なぜなら、1.5円投資して2円の利益が出ることが数学的に保証されているからです。
* **逆に**: 影の価格が0円のリソースがあれば、それは「在庫が余っている」ことを意味し、追加で購入する必要がないことがわかります。

### 2. 計算が劇的に早くなる場合があるから

最適化問題には、 **「変数の数」と「制約の数」** があります。

* **主問題**: 変数が100万個、制約が10個
* **双対問題**: 変数が10個、制約が100万個

数学的に、 **「変数が少なく制約が多い」問題よりも「変数が多く制約が少ない」問題の方が解きやすい** ケースが多々あります。
複雑すぎる主問題を、双対問題に「ひっくり返す」ことで、スパコンを使わなくても一瞬で解けるようになることがあるのです。

### 3. 「解の正しさ」を証明する物差しになるから

難しい最適化問題では、計算機が出した答えが本当に「世界で一番良い答え（大域最適解）」なのか確信が持てないことがあります。

ここで双対性が役立ちます。

* **弱双対性**: 「主問題の売上（最大化）」は、常に「双対問題のコスト（最小化）」以下になります。
* **双対ギャップ**: もし「主問題の答え」と「双対問題の答え」が一致すれば、その瞬間、 **「これ以上の正解は絶対に存在しない」という完璧な証明** になります。

これを **「双対ギャップがゼロになる」** と言い、アルゴリズムが終了して良いかどうかの判定基準に使われます。


## 4. 機械学習などのアルゴリズム設計に不可欠

現代のAI技術、例えば「サポートベクターマシン (SVM)」などのモデルでは、主問題を直接解くよりも、双対問題を解く方が「カーネル法」という強力なテクニックを使いやすくなるという性質があります。

双対性を利用することで、元の次元では見えなかったデータの境界線（最適解）が、高次元の視点からスッキリ見えるようになるのです。

## 双対問題にすると良いケース

計算が劇的に楽になる最も有名な例は、 **「変数の数が膨大で、制約条件が少ない」** というパターンの問題です。

具体的には、現代のAI技術の基礎である **サポートベクターマシン（SVM）** や、物流・ネットワークの**最大流問題**などが挙げられます。

### 1. サポートベクターマシン（SVM）の「カーネル法」

機械学習において、データを分類する境界線を見つけるSVMは、双対問題にすることの恩恵を最も受けているアルゴリズムの一つです。

* **主問題の悩み**:
データを高次元（例えば1万次元など）に飛ばして複雑な境界線を作ろうとすると、計算量がその次元数に応じて爆発します。
* **双対問題のメリット**:
双対問題に書き換えると、計算量は「次元数」ではなく **「データ数（サンプル数）」** に依存するようになります。
* **劇的な変化**:
この変換のおかげで、実質的に「無限次元」の計算を、データ同士の距離計算（カーネルトリック）だけで済ませることが可能になります。双対問題にしなければ、現代の高度な画像認識などは実現していなかったかもしれません。


### 2. 列生成法（大規模なスケジューリング）

航空機の乗務員スケジューリングや、配送ルートの最適化など、**「組み合わせのパターン数」が数億通りを超える**ような問題です。

* **主問題**:
「数億通りのルート候補」の中から最適なものを選ぶため、変数が数億個になり、メモリがパンクして解けません。
* **双対問題を利用したアプローチ（列生成法）**:
双対問題を解くことで得られる「影の価格」をヒントに、 **「今の答えを改善しそうな有望なルート（列）」だけをピンポイントで生成** します。
* **劇的な変化**:
数億個の変数をすべて用意する代わりに、双対問題を「ナビゲーター」として使い、必要な数十〜数百個の変数だけを扱うことで、不可能な計算を可能にします。


### 3. ネットワークの「最大流問題」と「最小カット問題」

あるネットワーク（例えばインターネットや道路網）で、A地点からB地点へ「最大どれだけのデータを送れるか」を考える問題です。

* **主問題（最大流）**:
各経路にどれだけ流すかをすべて計算する。
* **双対問題（最小カット）**:
ネットワークのどこを「切断」すればAとBが分断され、かつその切断コストが最小になるかを探す。
* **劇的な変化**:
最大流を直接求めるよりも、ネットワークの「ボトルネック（最小カット）」を探す双対問題の方が構造がシンプルになり、非常に高速なアルゴリズム（フォード・ファルカーソン法など）で解けるようになります。


## 実験
先日のジュース工場を例に双対問題にしたうえで最適化を行ってみます。

### 問題：ジュース工場の生産最適化

読者の方は一旦、ジュース工場の店長だとしていください。
リンゴとオレンジを使って、「特製ミックス」と「濃厚ブレンド」の2種類のジュースを作っています。在庫のフルーツをどう配分すれば、 **売上を最大化** できるかを考えてみます。

#### 1. 意思決定変数（あなたが決めること）

* $x$ ：特製ミックスの生産量（杯）
* $y$ ：濃厚ブレンドの生産量（杯）

#### 2. 制約条件（守らなければならないルール）

現在、手元にある材料の在庫には限りがあります。

* **リンゴの在庫**: 特製ミックス1杯に100g、濃厚ブレンド1杯に200g使います。在庫は合計で **2,000g** です。
* **オレンジの在庫**: 特製ミックス1杯に200g、濃厚ブレンド1杯に100g使います。在庫は合計で **2,000g** です。
* **非負制約**: 生産量はマイナスにはなりません（$x \ge 0, y \ge 0$）。

#### 3. 目的関数（最大化したいもの）

* **売上**: 特製ミックスは1杯 **500円**、濃厚ブレンドは1杯 **400円** で売れます。
* この売上の合計  $z = 500x + 400y$  を最大にしてください。

### 解法

実際に、最初にご紹介した「ジュース工場の最適化問題」を例に、 **主問題（生産最大化）** と **双対問題（資源価値最小化）** の両方をPythonで解き、その結果を比較してみましょう。

#### 1. 主問題と双対問題の整理

まず、プログラムに落とし込むために問題を整理します。

##### **主問題（Primal）**

* **目的**: 売上 $z = 500x + 400y$ を 最大化 する
* **制約**:
- $100x + 200y \le 2000$ （リンゴ）
- $200x + 100y \le 2000$ （オレンジ）

##### **双対問題（Dual）**

* **目的**: 総資源価値 $w = 2000u + 2000v$ を 最小化 する
* **制約**:
- $100u + 200v \ge 500$ （特製ミックスの価値）
- $200u + 100v \ge 400$ （濃厚ブレンドの価値）

#### 2. Pythonでの実装
Pythonの最適化ライブラリである `SciPy` を使用します。
`scipy.optimize.linprog` はデフォルトで「最小化」を行うため、主問題を解く際は目的関数にマイナスを掛けます。

実装コードは以下に保管しています。

https://github.com/Shinichi0713/recommendation-ai/tree/main/optimization/src/main_prob

```
=== 主問題 (Primal) の結果 ===
最適な生産量: 特製ミックス 6.67杯, 濃厚ブレンド 6.67杯
最大売上: 6000円

=== 双対問題 (Dual) の結果 ===
リンゴの価値(u): 1.00円/g
オレンジの価値(v): 2.00円/g
最小資源価値: 6000円
```

#### 3. 計算結果からわかること

このコードを実行すると、以下のような驚くべき結果が得られます。

| 項目 | 主問題 (生産者視点) | 双対問題 (資源視点) |
| --- | --- | --- |
| **導き出された値** | 6.67杯, 6.67杯 | 1.00円, 2.00円 |
| **最終的な目的関数の値** | **6,000円** | **6,000円** |

### 面白い点

1. **強双対性の証明**:
「最大売上」と「最小資源価値」がどちらも **6,000円** で一致しました。これは計算が正しく行われ、最適解に達した証拠です。
2. **影の価格 (Shadow Price)**:
双対問題の解  は、「リンゴ1gには1円の価値があり、オレンジ1gには2円の価値がある」ことを示しています。
3. **経営のヒント**:
オレンジの価値（2円）はリンゴ（1円）の2倍です。もし追加で材料を買うなら、オレンジを優先的に確保したほうが利益への貢献度が大きいことが一瞬でわかります。


## 総括
最適化問題は通常解く対象の主問題に対して、主問題の制約条件から目的関数を作る双対問題を導出する意義や、問題の具体例を挙げて説明をしました。
主問題が説明変数が爆発しているようなケースで是非利用下さいませ。


